<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>woodwhales-music</title>
    <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}">
    <link rel="stylesheet" th:href="@{/webjars/element-ui/lib/theme-chalk/index.css}">
    <script th:src="@{/webjars/vue/dist/vue.js}"></script>
    <script th:src="@{/webjars/element-ui/lib/index.js}"></script>
    <script type="text/javascript" th:src="@{/webjars/axios/dist/axios.js}"></script>
    <!-- https://aplayer.js.org/#/zh-Hans/ -->
    <script th:src="@{/aplyer/APlayer.min.js}"></script>
    <link rel="stylesheet" th:href="@{/aplyer/APlayer.min.css}">
</head>
<body>
    <div id="app">
        <el-row>
            <el-col :span="2">&nbsp;</el-col>
            <el-col :span="20">
                <el-row style="text-align: center;">
                    <h2>woodwhales-music</h2>
                    <el-link :underline="false" th:href="${musicSite}" target="_blank">
                        <svg t="1702282985669" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1101" width="25" height="25"><path d="M690.70866 333.35325c49.640584 82.136695 44.667316 268.000823 44.667316 268.000823S709.115891 421.37805 556.620755 422.642856l0 312.62209-18.49319 0c-23.294542 26.608008-65.953108 44.667316-115.417683 44.667316-73.979922 0-134.086881-39.957037-134.086881-89.289606 0-49.378617 60.106959-89.289606 134.086881-89.289606 15.70161 0 30.621415 2.136663 44.665269 5.496178L467.375152 243.934708l89.245603 0C556.620755 243.934708 653.107273 271.107581 690.70866 333.35325zM958.70846 243.934708l0 535.9996c0 98.711186-80.000032 178.709171-178.711218 178.709171L243.998665 958.64348c-98.623181 0-178.709171-79.997985-178.709171-178.709171L65.289494 243.934708c0-98.625228 80.08599-178.579211 178.709171-178.579211l535.998577 0C878.708428 65.355497 958.70846 145.30948 958.70846 243.934708zM869.374852 288.687982c0-74.067926-60.021002-134.042879-133.998877-134.042879L288.623002 154.645103c-73.979922 0-133.912919 59.974953-133.912919 134.042879l0 446.577988c0 74.023924 59.932997 134.086881 133.912919 134.086881l446.752973 0c73.977875 0 133.998877-60.062957 133.998877-134.086881L869.374852 288.687982z" p-id="1102" fill="#67C23A"></path></svg>
                    </el-link>
                </el-row>
                <el-row style="text-align: center; margin-bottom: 12px;">
                    <el-divider content-position="center"><span style="color: #67C23A;">移风易俗，莫善于乐。</span></el-divider>
                </el-row>
                <el-row>
                    <el-row :gutter="20">
                        <el-col :span="20">
                            <el-form ref="queryForm" :model="queryForm" label-width="80px" @submit.native.prevent>
                                <el-form-item label="名称/作者">
                                    <el-input v-model.trim="queryForm.searchInfo" @keyup.enter.native="onQuery"></el-input>
                                </el-form-item>
                            </el-form>
                        </el-col>
                        <el-col :span="4">
                            <el-button type="primary" @click="onQuery">搜索</el-button>
                            <el-button type="info" @click="onReset">重置</el-button>
                        </el-col>
                    </el-row>
                </el-row>
                <el-row style="text-align: left; margin-bottom: 12px;">
                    <el-button type="success" size="mini" icon="el-icon-plus" @click="onAdd">添加</el-button>
                    <el-button type="warning" size="mini" icon="el-icon-download" @click="onExport">导出</el-button>
                </el-row>
                <!-- 吸底播放 -->
                <el-row style="text-align: center; margin-bottom: 12px;" v-show="musicPlayer.musicAudioUrl !== null">
                    <div id="aplayer"></div>
                </el-row>
                <el-row style="margin-bottom: 12px;">
                    <el-table :data="sys.tableData" ref="tableList" style="width: 100%" @sort-change="sortChange">
                        <el-table-column
                                fixed
                                prop="title"
                                label="音乐名称">
                            <template slot-scope="scope">
                                <span v-show="scope.row.linked" style="color: #5FB878" >{{scope.row.title}}</span>
                                <span v-show="!scope.row.linked" style="color: #FF5722">{{scope.row.title}}</span>
                            </template>
                        </el-table-column>
                        <el-table-column
                                prop="artist"
                                label="作者">
                        </el-table-column>
                        <el-table-column label="封面">
                            <template slot-scope="scope">
                                <el-image
                                        :id="'image'+scope.row.id"
                                        style="width: 50px; height: 50px"
                                        :src="scope.row.coverUrl"
                                        fit="cover"></el-image>
                            </template>
                        </el-table-column>
                        <el-table-column
                                prop="album"
                                label="专辑">
                        </el-table-column>
                        <el-table-column
                                prop="sort"
                                label="排序"
                                :sortable="'custom'"
                                width="100">
                        </el-table-column>
                        <el-table-column
                                prop="gmtCreated"
                                :sortable="'custom'"
                                label="创建时间">
                        </el-table-column>
                        <el-table-column
                                prop="gmtModified"
                                :sortable="'custom'"
                                label="更新时间">
                        </el-table-column>
                        <el-table-column
                                fixed="right"
                                label="操作"
                                width="210">
                            <template slot-scope="scope">
                                <el-button @click="onEdit(scope.row)" type="success" size="mini" icon="el-icon-edit"></el-button>
                                <el-button @click="onDelete(scope.row)" type="danger" size="mini" icon="el-icon-delete"></el-button>
                                <template v-if="scope.row.audioUrl !== null">
                                    <el-button @click="onTry(scope.row)" type="primary" size="mini" icon="el-icon-headset"></el-button>
                                </template>
                            </template>
                        </el-table-column>
                    </el-table>
                </el-row>
                <el-row style="margin-bottom: 12px; text-align: center;">
                    <el-pagination
                            :current-page="sys.currentPage"
                            :page-size="sys.pageSize"
                            @size-change="handleSizeChange"
                            @current-change="handleCurrentChange"
                            :page-sizes="[10, 20, 50, 100, 300]"
                            layout="total, sizes, prev, pager, next, jumper"
                            :total="sys.total">
                    </el-pagination>
                </el-row>
                <el-row style="text-align: center; margin-bottom: 12px;">
                    <el-link :underline="false">&copy;&nbsp;&nbsp;{{sys.dateYear}}</el-link>&nbsp;&nbsp;<el-link :underline="false" type="success" href="https://woodwhales.cn/" target="_blank">woodwhales's blog</el-link>
                </el-row>
            </el-col>
            <el-col :span="2">&nbsp;</el-col>
        </el-row>
    </div>
</body>
<script type="text/javascript" th:inline="none">
    new Vue({
        el: '#app',
        data: function() {
            return {
                queryForm: {
                    searchInfo: null
                },
                sys: {
                    dateYear: new Date().getFullYear(),
                    total: 0,
                    currentPage: 1,
                    pageSize: 10,
                    orderBy: {
                        prop: null,
                        order: null
                    },
                    tableData: []
                },
                musicPlayer: {
                    musicName: null,
                    musicAuthor: null,
                    musicAudioUrl: null,
                    musicCoverUrl: null,
                    imageId: null
                }
            }
        },
        mounted() {
            this.initSys();
            this.initQueryForm();
            this.onQuery();
        },
        methods: {
            sortChange(column) {
                if(!column.order) {
                    this.sys.orderBy.prop = null
                    this.sys.orderBy.order = null
                } else {
                    this.sys.orderBy.prop = column.prop
                    this.sys.orderBy.order = column.order
                }
                this.onQuery()
            },
            initAplyer() {
                if(this.musicPlayer.musicAudioUrl !== null
                    || this.musicPlayer.musicCoverUrl !== '') {
                    const ap = new APlayer({
                        container: document.getElementById('aplayer'),
                        loop: 'none',
                        theme: '#5FB878',
                        audio: [{
                            name: this.musicPlayer.musicName,
                            artist: this.musicPlayer.musicAuthor,
                            url: this.musicPlayer.musicAudioUrl,
                            cover: this.musicPlayer.musicCoverUrl
                        }]
                    });
                    ap.play();
                }
            },
            onAdd() {
                location.href = './add'
            },
            onTry(row) {
                this.musicPlayer.musicAudioUrl = row.audioUrl;
                this.musicPlayer.musicCoverUrl = row.coverUrl;
                this.musicPlayer.musicName = row.title;
                this.musicPlayer.musicAuthor = row.artist;
                this.musicPlayer.imageId = 'image'+row.id;
                this.initAplyer();
            },
            onExport() {
                location.href = './export'
            },
            onReset: function () {
                this.$refs.tableList.clearSort()
                this.initSys();
                this.initQueryForm();
                this.onQuery();
            },
            initQueryForm() {
                this.queryForm.searchInfo = null
            },
            initSys: function () {
                this.sys.dateYear = new Date().getFullYear();
                this.sys.total = 0
                this.sys.currentPage = 1
                this.sys.pageSize = 10
                this.sys.orderBy.prop = null
                this.sys.orderBy.order = null
                this.sys.tableData = []
            },
            onQuery: function () {
                axios.post('./pageMusic', {
                    searchInfo: this.queryForm.searchInfo,
                    page: this.sys.currentPage,
                    limit: this.sys.pageSize,
                    orderBy: this.sys.orderBy
                })
                .then(response => {
                    if(response.data.code === 0) {
                        this.sys.total = response.data.count;
                        this.sys.tableData = response.data.data;
                    } else {
                        this.$message.error(response.data.msg);
                    }
                })
                .catch(error => {
                    this.$message.error(error);
                });
            },
            onEdit(row) {
                location.href = './add?id=' + row.id
            },
            onDelete(row) {
                this.$confirm('是否确认删除?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    axios.post('./deleteMusic', {
                        id: row.id
                    })
                    .then(response => {
                        if(response.data.code === 0) {
                            this.onQuery();
                            this.$message({
                                message: response.data.msg,
                                type: 'success'
                            });
                        } else {
                            this.$message.error(response.data.msg);
                        }
                    })
                    .catch(error => {
                        this.$message.error(error);
                    });
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '已取消删除'
                    });
                });
            },
            handleSizeChange(val) {
                this.sys.pageSize = val
                this.onQuery();
            },
            handleCurrentChange(val) {
                this.sys.currentPage = val
                this.onQuery();
            }
        }
    })
</script>
</html>
